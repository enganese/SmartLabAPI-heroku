<link
  href="https://select2.org/assets/5ad898c30986b0985fd29e4a8ca9d1cb.css"
  type="text/css"
  rel="stylesheet"
/>
<script src="https://select2.org/assets/3463b090afc66f573d74febe0935c1f6.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  .cards {
    display: inline-grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 20px;
    width: 90%;
  }

  p {
      color: white;
  }

  .card {
      margin-top: 34px;
  }

  body {
    background-color: #060d29;
    font-family: GothamPro;
    margin: auto;
    user-drag: none;
    -webkit-user-drag: none;
    user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 300px;
    height: 30px;
    /*box-shadow: #f8a232 0px 0px 20px;*/
    border-radius: 5px;
    margin-top: 3px;
    /* pointer-events:none; */
    user-drag: none;
    -webkit-user-drag: none;
    user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .select2-container--default .select2-search--dropdown .select2-search__field {
    border: none;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    font-size: 15px;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #060d29;
    -webkit-transition: 0.4s;
    transition: 0.4s;
    font-family: inter;
    color: #060d29;
    /*box-shadow: rgb(100 100 111 / 20%) 0px 0px 12px 1px;*/
  }

  .slider:before {
    position: absolute;
    height: 26px;
    width: 146px;
    left: 3px;
    bottom: 4px;
    content: "год";
    background-color: #f8a232;
    -webkit-transition: 0.4s;
    transition: 0.4s;
  }

  input:checked + .slider {
    background-color: #f8a232;
    color: #f8a232;
  }

  input:checked + .slider:before {
    -webkit-transform: translateX(150px);
    -ms-transform: translateX(150px);
    transform: translateX(150px);
    left: 2px;
    content: "квартал";
    background-color: #060d29;
  }

  /* Rounded sliders */
  .slider.round {
    border-radius: 5px;
  }

  .slider.round:before {
    border-radius: 5px;
    text-align: center;
    top: 2px;
  }

  .containerForContainerForThatShit {
      display: flex;
      width: 100%;
      height: 34px;
      justify-content: center;
      align-items: center;

  }

  .containerForThatShit {
    display: flex;
    box-shadow: rgb(100 100 111 / 80%) 0px 0px 15px 1px
    padding-top: 4px;
  }

  @media (min-width: 960px) {
      .containerForThatShit{
        flex-direction: row;
        justify-content: space-evenly;
        align-items: center;
        width: 610px;
        height: 30px;
        border-radius: 5px;
      }
  }

  @media (max-width: 960px) {
      .containerForThatShit{
          flex-direction: column-reverse;
          justify-content: center;
          align-items: center;
          width: auto;
          height: 100px;
      }
  }

  .select2-container--default .select2-selection--single {
    background-color: #f8a232;
    border: none;
    border-radius: 5px;
  }

  .select2-search--dropdown {
    background-color: #f8a232;
    border-radius: 5px;
  }

  .select2-search__field:focus {
    border: 0px;
    box-shadow: none;
    text-shadow: none;
    font-weight: 500;
  }

  .select2-container--default
    .select2-results__option--highlighted.select2-results__option--selectable {
    background-color: #060d29;
    color: white;
    border-radius: 5px;
  }

  .select2-results {
    background-color: #f8a232;
  }

  .select2-container--default.select2-container--open.select2-container--below
    .select2-selection--single,
  .select2-container--default.select2-container--open.select2-container--below
    .select2-selection--multiple {
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    width: 100%;
    background-color: #f8a232;
    color: #060d29;
    border-width: 0px;
  }

  .select2-container--default
    .select2-selection--single
    .select2-selection__arrow
    b {
    border-color: #060d29 transparent transparent transparent;
    border-style: solid;
    border-width: 5px 4px 0 4px;
    height: 0;
    left: 30%;
    margin-left: -4px;
    position: absolute;
    top: 50%;
    width: 0;
  }

  .select2-container--default .select2-results>.select2-results__options {
    background-color: #f8a232;
    border-radius: 5px;
  }

  .select2-container--default .select2-results__option--disabled {
    color: #060d29;
  }

  body {
    background-color: #060d29;
    color: #060d29;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    margin: auto;
  }

  .select2-container--default.select2-container--open
    .select2-selection--single
    .select2-selection__arrow
    b {
    border-color: transparent transparent #181e41 transparent;
    border-width: 0 4px 5px 4px;
  }

  .select2-container--default
    .select2-selection--single
    .select2-selection__rendered[title] {
    border-width: 0px;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 28px;
    font-size: 15px;
    background-color: #f8a232;
    color: #060d29;
    border-radius: 5px;
  }

  .select2-container {
      margin-bottom: 6px;
  }

  .select2-container--default
    .select2-selection--single
    .select2-selection__rendered {
    color: #060d29;
    border-width: 0px;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 28px;
    font-size: 15px;
    background-color: #f8a232;
    border-top-left-radius: 5px;
    border-bottom-left-radius: 5px;
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
  }

  .select2-dropdown {
    border: none;
  }

  .select2-container--open .select2-dropdown--below {
      background-color: #f8a232;
  }

  /*@media (min-width: 600px) {*/
    /* Desktop version */
  /*  .select2-container--default*/
  /*    .select2-selection--single*/
  /*    .select2-selection__rendered {*/
  /*    width: 300px;*/
  /*    height: 29px;*/
  /*    padding-top: 1px;*/
  /*  }*/

  /*  .select2-dropdown {*/
  /*    width: 300px;*/
  /*  }*/

  /*  .select2-container--default*/
  /*    .select2-selection--single*/
  /*    .select2-selection__rendered[title] {*/
  /*    width: 300px;*/
  /*    height: 29px;*/
  /*    padding-top: 1px;*/
  /*  }*/
  /*}*/

  /*@media (max-width: 600px) {*/
    /* Mobile version */
    .select2-container--default
      .select2-selection--single
      .select2-selection__rendered {
      width: 300px;
      height: 30px;
      padding-top: 1px;
    }

    .select2-container--open .select2-dropdown--above {
        background-color: #f8a232;
    }

    .select2-dropdown {
      width: 300px;
    }

    .select2-container--default
      .select2-selection--single
      .select2-selection__rendered[title] {
      width: 300px;
      height: 30px;
      padding-top: 1px;
    }
  /*}*/

  .select2-container--default .select2-selection--single .select2-selection__arrow b {
        margin-top: -1px;
    }

  .select2-container--default
    .select2-selection--single
    .select2-selection__placeholder {
    color: #181e41;
    text-align: center;
    /*padding-left: 65px;*/
  }

  .select2-results {
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    font-size: 14px;
    text-align: center;
  }

  .select2-container--default
    .select2-selection--single
    .select2-selection__clear {
    cursor: pointer;
    float: right;
    font-weight: 700;
    padding-right: 10px;
    height: 100%;
    background-color: #f8a232;
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
  }

  .select2-container--default
    .select2-selection--single
    .select2-selection__arrow {
    height: 26px;
    position: absolute;
    top: 0px;
    right: 1px;
    background-color: #f8a232;
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
    height: 100%;
    width: 20px;
  }

  .js-example-data-ajax {
    display: flex;
    width: 100%;
    min-width: 100%;
    max-width: 100%;
  }

  input[type="search"]:focus {
    background-color: white;
    border: 0px;
    box-shadow: none;
    border-radius: 5px;
    height: 30px;
  }

  input[type="search"] {
    background-color: white;
    border: 0px;
    box-shadow: none;
    border-radius: 5px;
    height: 30px;
  }
</style>

<div class="containerForContainerForThatShit">
  <div class="containerForThatShit">
    <select
      class="js-example-data-ajax form-control"
      data-select2-id="select2-data-1-83eu"
      tabindex="-1"
      aria-hidden="true"
    ></select>
    <label class="switch">
      <input type="checkbox" />
      <span class="slider round"></span>
    </label>
  </div>
</div>

<div class="currencyText">
  <p id="currency_text">Здесь будет отображаться валюта отчета</p>
</div>

<div class="cards">
  <!-- <figure class="card" style="width:550px">
      <div id="years_by_quarters_diagram"></div>
    </figure> -->

  <figure class="card" style="width: 550px">
    <div id="debt_ebitda"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="ev_ebitda"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="p_e"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="p_s"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="roe"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="net_margin"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="p_b_v"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="revenue"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="dividend"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="dividend_payout"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="fcf"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="operating_income"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="net_income"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="ebitda"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="number_of_shares"></div>
  </figure>

  <figure class="card" style="width: 550px">
    <div id="net_debt"></div>
  </figure>
</div>

<script type="text/javascript" class="js-code-placeholder">
  $(".js-example-data-ajax").select2({
    ajax: {
      url: "https://smartlab.herokuapp.com/autocomplete?direct_info=true",
      dataType: "json",
      delay: 250,
      data: function (params) {
        return {
          value: params.term, // search term
        };
      },
      processResults: function (data, params) {
        // parse the results into the format expected by Select2
        // since we are using custom formatting functions we do not need to
        // alter the remote JSON data, except to indicate that infinite
        // scrolling can be used
        return {
          results: normalizeData(data),
        };
      },
      cache: true,
    },
    width: "auto",
    placeholder: "Ищите компанию",
    minimumInputLength: 1,
    maximumInputLength: 40, // only allow terms up to 20 characters long
    templateResult: formatInfo,
    templateSelection: formatInfoSelection,
    allowClear: false,
    language: {
      // You can find all of the options in the language files provided in the
      // build. They all must be functions that return the string that should be
      // displayed.
      inputTooShort: function () {
        return "Введите название или тикер компаний";
      },
      inputTooLong: function () {
        return "Не более 40 символов";
      },
      noResults: function () {
        return "Ничего не найдено";
      },
      maximumSelectionLength: 1,
    },
  });

  $(".js-example-data-ajax").on("select2:select", function (e) {
    var data = e.params.data;
    console.log("Data:", data);
    var isChecked = document.getElementsByTagName("input")[0].checked;

    if (isChecked) {
      fetch(`https://smartlab.herokuapp.com/${data.company_url}/quarter`)
        .then((ret) => ret.json())
        .then((data) => {
          setQuarter(data);
          console.log("NEW quarter data:", data);
          var needed_data = [
            "debt_ebitda",
            "ev_ebitda",
            "p_e",
            "p_s",
            "roe",
            "net_margin",
            "p_b_v",
            "revenue",
            "dividend",
            "dividend_payout",
            "fcf",
            "operating_income",
            "net_income",
            "ebitda",
            "number_of_shares",
            "net_debt",
          ];
          for (var elem in data.data) {
            if (needed_data.includes(elem)) {
              console.log("elem", elem);
              let chartStatus = Chart.getChart(elem); // <canvas> id
              if (chartStatus != undefined) {
                chartStatus.destroy();
              }
              var elementLabels = data.data.years.values;
              var elementData = data.data[elem].values;
              var elementLabel = data.data[elem].aliases[0];
              var elementPeriod = data.period;
              var elementTicker = data.ticker;
              var elementId = elem;
              var elementType = "bar";
              var logo = false;
              var currency = data.data.currency.values[0];

              if (data.data[elem].values.length > 1) {
                drawChartWithLogo({
                  elementId,
                  elementLabels,
                  elementPeriod,
                  elementTicker,
                  elementLabel,
                  elementData,
                  elementType,
                  logo,
                  currency,
                });
              } else {
                elementData = [
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                ];
                logo = true;
                drawChartWithLogo({
                  elementId,
                  elementLabels,
                  elementPeriod,
                  elementTicker,
                  elementLabel,
                  elementData,
                  elementType,
                  logo,
                  currency,
                });
              }
            }
          }
        });
    } else if (!isChecked) {
      fetch(`https://smartlab.herokuapp.com/${data.company_url}/year`)
        .then((ret) => ret.json())
        .then((data) => {
          setYear(data);
          console.log("NEW year data:", data);
          var needed_data = [
            "debt_ebitda",
            "ev_ebitda",
            "p_e",
            "p_s",
            "roe",
            "net_margin",
            "p_b_v",
            "revenue",
            "dividend",
            "dividend_payout",
            "fcf",
            "operating_income",
            "net_income",
            "ebitda",
            "number_of_shares",
            "net_debt",
          ];
          for (var elem in data.data) {
            if (needed_data.includes(elem)) {
              console.log("elem", elem);
              let chartStatus = Chart.getChart(elem); // <canvas> id
              if (chartStatus != undefined) {
                chartStatus.destroy();
              }
              var elementLabels = data.data.years.values;
              var elementData = data.data[elem].values;
              var elementLabel = data.data[elem].aliases[0];
              var elementPeriod = data.period;
              var elementTicker = data.ticker;
              var elementId = elem;
              var elementType = "bar";
              var logo = false;
              console.log(
                "data.data.currency.values[0]",
                data.data.currency.values[0]
              );
              var currency = data.data.currency.values[0];

              if (data.data[elem].values.length > 1) {
                drawChartWithLogo({
                  elementId,
                  elementLabels,
                  elementPeriod,
                  elementTicker,
                  elementLabel,
                  elementData,
                  elementType,
                  logo,
                  currency,
                });
              } else {
                elementData = [
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                ];
                logo = true;
                drawChartWithLogo({
                  elementId,
                  elementLabels,
                  elementPeriod,
                  elementTicker,
                  elementLabel,
                  elementData,
                  elementType,
                  logo,
                  currency,
                });
              }
            }
          }
        });
    }
  });

  function drawChart(data) {
    let { shortName, title, categories, dividend, div_yield, div_payout_ratio, dividend_payout, field, point_format } = data;
    
  }

  function drawAllCharts(allData) {
    var period = allData.period;
    let innerData = allData.data;

    for (const property in innerData) {
      try {
        if (shortName.startsWith("dividend")) {
          let report = innerData[property]; // dividend or div_payout

          let shortName = report.name;
          
          let title = report.title;
          let categories = report.categories;
          
          let dividend = report.dividend;
          let div_yield = report.div_yield;
          let div_payout_ratio = report.div_payout_ratio;
          let dividend_payout = report.dividend_payout;

          let field = report.field;
          ]

          \

          4
          ]
          let point_format = report.point_format;

          let full_data = {
            shortName: shortName,
            title: title,
            categories: categories,
            dividend: dividend,
            div_yield: div_yield,
            div_payout_ratio: div_payout_ratio,
            dividend_payout: dividend_payout,
            field: field,
            point_format: point_format,
          };

          drawChat(full_data)
        } else {
          let report = innerData[property];

          let shortName = property.toString();
          let title = report.title;
          let categories = report.categories;
          let data = report.data;

          let full_data = {
            shortName: shortName,
            title: title,
            categories: categories,
            data: data,
          };

          drawChat(full_data);
        }
      } catch (err) {
        console.error("Хьюстон, у нас проблемы! \nОшибка:", err)
      }
    }
  }

  function drawChartWithLogo({
    elementId,
    elementTicker,
    elementPeriod,
    elementLabels,
    elementLabel,
    elementData,
    elementType,
    logo,
    currency,
  }) {
    var currency_text = document.getElementById("currency_text");
    currency_text.innerHTML = `Валюта: ${currency}`;

    const data = {
      labels: elementLabels,
      datasets: [
        {
          label: `${elementLabel} | ${elementTicker} | ${
            elementPeriod === "year" ? "Годовой" : "Квартальный"
          }`,
          data: elementData,
          backgroundColor: "#f8a232",
          borderColor: "#f8a232",
          borderWidth: 1,
        },
      ],
    };
    // </block:setup>

    // <block:plugin:2>
    // Note: changes to the plugin code is not reflected to the chart, because the plugin is loaded at chart construction time and editor changes only trigger an chart.update().

    const image = new Image();
    image.src = "https://svgshare.com/i/iPX.svg";
    image.src = "https://i.imgur.com/jCMQACC.png";

    const plugin = {
      id: "custom_canvas_background_image",
      beforeDraw: (chart) => {
        if (image.complete) {
          const ctx = chart.ctx;
          const { top, left, width, height } = chart.chartArea;
          const x = left + width / 3 - image.width / 5;
          const y = top + height / 4 - image.height + 55;
          ctx.drawImage(image, x, y);
        } else {
          image.onload = () => chart.draw();
        }
      },
    };
    // </block:plugin>

    // <block:config:0>
    const config = {
      type: elementType,
      data: data,

      /* Turn on plugins, when you need background image! */
      plugins: logo ? [plugin] : [],
    };
    // </block:config>

    const ctx = document.getElementById(elementId).getContext("2d");
    const myChart = new Chart(ctx, config);
  }

  function formatInfo(info) {
    if (info.loading) {
      return "Поиск...";
    }

    var $container = $(
      "<div class='select2-result clearfix'>" +
        "<div class='select2-result-company__name'></div>" +
        "</div>"
    );

    $container
      .find(".select2-result-company__name")
      .text(`${info.value} [${info.symbol}]`)
      .css("background-color", "transparent");

    return $container;
  }

  function formatInfoSelection(info) {
    if (info.value) {
      return `${info.value} [${info.symbol}]` || info.value;
    } else {
      return "Выбрать компанию";
    }
  }

  function normalizeData(data) {
    data.forEach((item) => {
      item["id"] = item["data"];
      delete item["data"];
    });

    return data;
  }

  const useState = (defaultValue) => {
    let value = defaultValue;
    const getValue = () => value;
    const setValue = (newValue) => (value = newValue);
    return [getValue, setValue];
  };

  const [year, setYear] = useState(undefined);
  const [quarter, setQuarter] = useState(undefined);

  document.addEventListener("input", (input) => {
    console.log("input:", input);
    if (input.data !== undefined) {
      return null;
    }

    var data = $(".js-example-data-ajax").select2("data");

    if (input.target.checked && data.length > 0) {
      if (quarter() === undefined) {
        fetch(`https://smartlab.herokuapp.com/${data[0].company_url}/quarter`)
          .then((ret) => ret.json())
          .then((data) => {
            setQuarter(data);
            console.log("NEW quarter data1:", data);
            var needed_data = [
              "debt_ebitda",
              "ev_ebitda",
              "p_e",
              "p_s",
              "roe",
              "net_margin",
              "p_b_v",
              "revenue",
              "dividend",
              "dividend_payout",
              "fcf",
              "operating_income",
              "net_income",
              "ebitda",
              "number_of_shares",
              "net_debt",
            ];
            for (var elem in data.data) {
              if (needed_data.includes(elem)) {
                console.log("elem", elem);
                let chartStatus = Chart.getChart(elem); // <canvas> id
                if (chartStatus != undefined) {
                  chartStatus.destroy();
                }
                var elementLabels = data.data.years.values;
                var elementData = data.data[elem].values;
                var elementLabel = data.data[elem].aliases[0];
                var elementPeriod = data.period;
                var elementTicker = data.ticker;
                var elementId = elem;
                var elementType = "bar";
                var logo = false;
                var currency = data.data.currency.values[0];

                if (data.data[elem].values.length > 1) {
                  drawChartWithLogo({
                    elementId,
                    elementLabels,
                    elementPeriod,
                    elementTicker,
                    elementLabel,
                    elementData,
                    elementType,
                    logo,
                    currency,
                  });
                } else {
                  elementData = [
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                  ];
                  logo = true;
                  drawChartWithLogo({
                    elementId,
                    elementLabels,
                    elementPeriod,
                    elementTicker,
                    elementLabel,
                    elementData,
                    elementType,
                    logo,
                    currency,
                  });
                }
              }
            }
          });
      } else if (quarter()) {
        if (quarter().ticker === year().ticker) {
          console.log("OLD cached quarter data:", quarter());
          var data = quarter();
          var needed_data = [
            "debt_ebitda",
            "ev_ebitda",
            "p_e",
            "p_s",
            "roe",
            "net_margin",
            "p_b_v",
            "revenue",
            "dividend",
            "dividend_payout",
            "fcf",
            "operating_income",
            "net_income",
            "ebitda",
            "number_of_shares",
            "net_debt",
          ];
          for (var elem in data.data) {
            if (needed_data.includes(elem)) {
              console.log("elem", elem);
              let chartStatus = Chart.getChart(elem); // <canvas> id
              if (chartStatus != undefined) {
                chartStatus.destroy();
              }
              var elementLabels = data.data.years.values;
              var elementData = data.data[elem].values;
              var elementLabel = data.data[elem].aliases[0];
              var elementPeriod = data.period;
              var elementTicker = data.ticker;
              var elementId = elem;
              var elementType = "bar";
              var logo = false;
              var currency = data.data.currency.values[0];

              if (data.data[elem].values.length > 1) {
                drawChartWithLogo({
                  elementId,
                  elementLabels,
                  elementPeriod,
                  elementTicker,
                  elementLabel,
                  elementData,
                  elementType,
                  logo,
                  currency,
                });
              } else {
                elementData = [
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                ];
                logo = true;
                drawChartWithLogo({
                  elementId,
                  elementLabels,
                  elementPeriod,
                  elementTicker,
                  elementLabel,
                  elementData,
                  elementType,
                  logo,
                  currency,
                });
              }
            }
          }
        } else if (quarter().ticker !== year().ticker) {
          fetch(`https://smartlab.herokuapp.com/${data[0].company_url}/quarter`)
            .then((ret) => ret.json())
            .then((data) => {
              setQuarter(data);
              console.log("NEW quarter data2:", data);
              var needed_data = [
                "debt_ebitda",
                "ev_ebitda",
                "p_e",
                "p_s",
                "roe",
                "net_margin",
                "p_b_v",
                "revenue",
                "dividend",
                "dividend_payout",
                "fcf",
                "operating_income",
                "net_income",
                "ebitda",
                "number_of_shares",
                "net_debt",
              ];
              for (var elem in data.data) {
                if (needed_data.includes(elem)) {
                  console.log("elem", elem);
                  let chartStatus = Chart.getChart(elem); // <canvas> id
                  if (chartStatus != undefined) {
                    chartStatus.destroy();
                  }
                  var elementLabels = data.data.years.values;
                  var elementData = data.data[elem].values;
                  var elementLabel = data.data[elem].aliases[0];
                  var elementPeriod = data.period;
                  var elementTicker = data.ticker;
                  var elementId = elem;
                  var elementType = "bar";
                  var logo = false;
                  var currency = data.data.currency.values[0];

                  if (data.data[elem].values.length > 1) {
                    drawChartWithLogo({
                      elementId,
                      elementLabels,
                      elementPeriod,
                      elementTicker,
                      elementLabel,
                      elementData,
                      elementType,
                      logo,
                      currency,
                    });
                  } else {
                    elementData = [
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                    ];
                    logo = true;
                    drawChartWithLogo({
                      elementId,
                      elementLabels,
                      elementPeriod,
                      elementTicker,
                      elementLabel,
                      elementData,
                      elementType,
                      logo,
                      currency,
                    });
                  }
                }
              }
            });
        }
      }
    } else if (!input.target.checked && data.length > 0) {
      if (year() === undefined) {
        fetch(`https://smartlab.herokuapp.com/${data[0].company_url}/year`)
          .then((ret) => ret.json())
          .then((data) => {
            setYear(data);
            console.log("NEW year data:", data);
            var needed_data = [
              "debt_ebitda",
              "ev_ebitda",
              "p_e",
              "p_s",
              "roe",
              "net_margin",
              "p_b_v",
              "revenue",
              "dividend",
              "dividend_payout",
              "fcf",
              "operating_income",
              "net_income",
              "ebitda",
              "number_of_shares",
              "net_debt",
            ];
            for (var elem in data.data) {
              if (needed_data.includes(elem)) {
                console.log("elem", elem);
                let chartStatus = Chart.getChart(elem); // <canvas> id
                if (chartStatus != undefined) {
                  chartStatus.destroy();
                }
                var elementLabels = data.data.years.values;
                var elementData = data.data[elem].values;
                var elementLabel = data.data[elem].aliases[0];
                var elementPeriod = data.period;
                var elementTicker = data.ticker;
                var elementId = elem;
                var elementType = "bar";
                var logo = false;
                var currency = data.data.currency.values[0];

                if (data.data[elem].values.length > 1) {
                  drawChartWithLogo({
                    elementId,
                    elementLabels,
                    elementPeriod,
                    elementTicker,
                    elementLabel,
                    elementData,
                    elementType,
                    logo,
                    currency,
                  });
                } else {
                  elementData = [
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                    "Недоступно / Not available",
                  ];
                  logo = true;
                  drawChartWithLogo({
                    elementId,
                    elementLabels,
                    elementPeriod,
                    elementTicker,
                    elementLabel,
                    elementData,
                    elementType,
                    logo,
                    currency,
                  });
                }
              }
            }
          });
      } else if (year()) {
        if (year().ticker === quarter().ticker) {
          console.log("OLD cached year data:", year());

          var data = year();
          var needed_data = [
            "debt_ebitda",
            "ev_ebitda",
            "p_e",
            "p_s",
            "roe",
            "net_margin",
            "p_b_v",
            "revenue",
            "dividend",
            "dividend_payout",
            "fcf",
            "operating_income",
            "net_income",
            "ebitda",
            "number_of_shares",
            "net_debt",
          ];
          for (var elem in data.data) {
            if (needed_data.includes(elem)) {
              console.log("elem", elem);
              let chartStatus = Chart.getChart(elem); // <canvas> id
              if (chartStatus != undefined) {
                chartStatus.destroy();
              }
              var elementLabels = data.data.years.values;
              var elementData = data.data[elem].values;
              var elementLabel = data.data[elem].aliases[0];
              var elementPeriod = data.period;
              var elementTicker = data.ticker;
              var elementId = elem;
              var elementType = "bar";
              var logo = false;
              var currency = data.data.currency.values[0];

              if (data.data[elem].values.length > 1) {
                drawChartWithLogo({
                  elementId,
                  elementLabels,
                  elementPeriod,
                  elementTicker,
                  elementLabel,
                  elementData,
                  elementType,
                  logo,
                  currency,
                });
              } else {
                elementData = [
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                  "Недоступно / Not available",
                ];
                logo = true;
                drawChartWithLogo({
                  elementId,
                  elementLabels,
                  elementPeriod,
                  elementTicker,
                  elementLabel,
                  elementData,
                  elementType,
                  logo,
                  currency,
                });
              }
            }
          }
        } else if (year().ticker !== quarter().ticker) {
          fetch(`https://smartlab.herokuapp.com/${data[0].company_url}/year`)
            .then((ret) => ret.json())
            .then((data) => {
              setYear(data);
              console.log("NEW year data:", data);
              var needed_data = [
                "debt_ebitda",
                "ev_ebitda",
                "p_e",
                "p_s",
                "roe",
                "net_margin",
                "p_b_v",
                "revenue",
                "dividend",
                "dividend_payout",
                "fcf",
                "operating_income",
                "net_income",
                "ebitda",
                "number_of_shares",
                "net_debt",
              ];
              for (var elem in data.data) {
                if (needed_data.includes(elem)) {
                  console.log("elem", elem);
                  let chartStatus = Chart.getChart(elem); // <canvas> id
                  if (chartStatus != undefined) {
                    chartStatus.destroy();
                  }
                  var elementLabels = data.data.years.values;
                  var elementData = data.data[elem].values;
                  var elementLabel = data.data[elem].aliases[0];
                  var elementPeriod = data.period;
                  var elementTicker = data.ticker;
                  var elementId = elem;
                  var elementType = "bar";
                  var logo = false;
                  var currency = data.data.currency.values[0];

                  if (data.data[elem].values.length > 1) {
                    drawChartWithLogo({
                      elementId,
                      elementLabels,
                      elementPeriod,
                      elementTicker,
                      elementLabel,
                      elementData,
                      elementType,
                      logo,
                      currency,
                    });
                  } else {
                    elementData = [
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                      "Недоступно / Not available",
                    ];
                    logo = true;
                    drawChartWithLogo({
                      elementId,
                      elementLabels,
                      elementPeriod,
                      elementTicker,
                      elementLabel,
                      elementData,
                      elementType,
                      logo,
                      currency,
                    });
                  }
                }
              }
            });
        }
      }
    }
  });
</script>

<figure class="highcharts-figure">
  <div id="years_by_quarters_diagram"></div>
</figure>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script>
  if ("years_by_quarters_diagram" in aQuarterData) {
    Highcharts.chart("years_by_quarters_diagram", {
      chart: {
        type: "column",
        backgroundColor: "#060d29",
      },
      title: {
        text: null,
      },
      xAxis: {
        categories: aQuarterData["years_by_quarters_diagram"]["categories"],
      },
      yAxis: {
        title: {
          text: null,
        },
        gridLineColor: "#ffffff",
        gridLineWidth: 0,
      },
      credits: {
        enabled: true,
        text: "TREE INVEST",
        href: "https://treeinvest.ru",
        position: {
          align: "center",
          verticalAlign: "center",
          x: 10,
          y: 60,
        },
        style: {
          color: "#f8a232",
          fontSize: "70px",
          fontFamily: "myriad pro",
          opacity: 0.3,
          fontWeight: "bold",
        },
      },
      legend: {
        enabled: true,
      },
      tooltip: {
        useHTML: true,
        headerFormat:
          aQuarterData["years_by_quarters_diagram"]["header_format"],
        pointFormat: aQuarterData["years_by_quarters_diagram"]["point_format"],
      },
      plotOptions: {
        column: {
          stacking: "normal",
          dataLabels: {
            enabled: false,
          },
        },
      },
      series: aQuarterData["years_by_quarters_diagram"]["series"],
    });
  }
</script>
